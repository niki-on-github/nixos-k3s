apiVersion: traefik.containo.us/v1alpha1
kind: ServersTransport
metadata:
  name: ${APP_NAME}-transport
  namespace: ${APP_NAMESPACE}
spec:
  insecureSkipVerify: true
---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: &app ${APP_NAME}
  namespace: ${APP_NAMESPACE}
spec:
  chart:
    spec:
      chart: app-template
      version: 2.6.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system

  values:
    global:
      nameOverride: *app

    controllers:
      main:    
        containers:
          main:
            securityContext:
              privileged: true
              fsGroup: 0
              runAsUser: 0
              runAsGroup: 0

            image:
              repository: kasmweb/workspaces
              tag: "1.15.1"
              #repository: "lscr.io/linuxserver/kasm"
              #tag: "1.15.0-ls16"


            env:
              TZ: "${CONFIG_TIMEZONE}"
              KASM_PORT: 443

            # NOTE: Disable the probes for the dind kasm setup because the port 443 is only available when the setup on port 3000 was completed
            probes:
              liveness: &probe
                custom: true
                spec:
                  exec:
                    command:
                    - "ls"
              readiness: *probe
              startup: *probe
 
    service:
      main:
        annotations:
          traefik.ingress.kubernetes.io/service.serversscheme: https
          traefik.ingress.kubernetes.io/service.serverstransport: "${APP_NAMESPACE}-${APP_NAME}-transport@kubernetescrd"
        ports:
          http:
            enabled: true
            port: 443
            protocol: HTTPS
          install:
            enabled: true
            port: 3000
            protocol: HTTPS


    ingress:
      main:
        enabled: true
        className: traefik
        annotations:
          traefik.ingress.kubernetes.io/router.entrypoints: websecure
        hosts:
          - host: &ingress1 "kasm.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  name: main
                  port: http
        tls:
          - hosts:
              - *ingress1
      install:
        enabled: true
        className: traefik
        annotations:
          traefik.ingress.kubernetes.io/router.entrypoints: websecure
        hosts:
          - host: &ingress2 "kasm-install.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
                service:
                  name: main
                  port: install
        tls:
          - hosts:
              - *ingress2
  
    persistence:
      data:
        enabled: true
        type: persistentVolumeClaim
        accessMode: ReadWriteOnce
        size: 32Gi
        storageClass: "local-persistent"
        globalMounts:
          - path: /opt
